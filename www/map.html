<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.91/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.91/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="map.css" rel="stylesheet">
  </head>
  <body>
    <div id="cesiumContainer"></div>
    <div id="toolbar">
      <i>Note that all evelations are 5x exaggerated.</i>
      <table id="checkboxes">
        <tr><td><input type="checkbox" onchange="viewer.scene.imageryLayers.get(2).show = this.checked;" checked/></td><td>Sectional Charts</td></tr>
        <tr><td><input type="checkbox" onchange="viewer.scene.imageryLayers.get(3).show = this.checked;" checked/></td><td>TAC Charts</td></tr>
        <tr><td><input type="checkbox" onchange="showTerrain(this.checked);"/></td><td>Terrain</td></tr>
        <tr><td>&nbsp;</td><td></td></tr>
      </table>
    </div>
    <script>
      d2r = 3.1415972 / 180
      Cesium.Camera.DEFAULT_VIEW_RECTANGLE = Cesium.Rectangle.fromDegrees(-127,30,-110,50);
      Cesium.Camera.DEFAULT_VIEW_FACTOR = 0;

      Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIwMDU1NzUwNi0yNjdjLTRjYTktOTJhZS02ZTMxMWI5YmNhMGEiLCJpZCI6ODg0MSwiaWF0IjoxNjI1MDIwMTk3fQ.PKYn_UKdoBoXROZTihLa_WmmpmRLEWg38uEXxFniHeI';
      var viewer = new Cesium.Viewer('cesiumContainer', {
          baseLayerPicker : false,
          terrainProvider : new Cesium.EllipsoidTerrainProvider({}),
          timeline: false,
          shadows: true,
      });


      if (false) {
          viewer.extend(Cesium.viewerCesium3DTilesInspectorMixin);
          var inspectorViewModel = viewer.cesium3DTilesInspector.viewModel;
      }
      earth_layer = new Cesium.UrlTemplateImageryProvider({
          url : 'tiles/earth/{z}/{x}/{y}.png',
          hasAlphaChannel: false,
          //minimumLevel: 8,
          maximumLevel: 2,
      });
      viewer.scene.imageryLayers.addImageryProvider(earth_layer);

      sec_layer = new Cesium.UrlTemplateImageryProvider({
          url : 'tiles/sec/{z}/{x}/{y}.png',
          credit : 'Artfahrt Inc',
          hasAlphaChannel: true,
          maximumLevel: 12,
      });
      viewer.scene.imageryLayers.addImageryProvider(sec_layer);

      tac_layer = new Cesium.UrlTemplateImageryProvider({
          url : 'tiles/tac/{z}/{x}/{y}.png',
          credit : 'Artfahrt Inc',
          hasAlphaChannel: true,
          //minimumLevel: 8,
          maximumLevel: 12,
      });

      viewer.scene.imageryLayers.addImageryProvider(tac_layer);

      viewer.scene.globe.depthTestAgainstTerrain = true;
      viewer.scene.globe.terrainExaggeration = 5.0;

      function showTerrain(on)
      {
          if (on) {
	      viewer.terrainProvider = Cesium.createWorldTerrain({
                  requestWaterMask : false,
                  requestVertexNormals : true,
              });
          } else {
              viewer.terrainProvider = new Cesium.EllipsoidTerrainProvider({});
          }
      }

      airports = ['KSFO', 'KSJC', 'KOAK', 'KSQL', 'KPAO', 'KNUQ', 'KRHV', 'KHWD'];
      //airports.push('KAPC', 'KCCR', 'KLVK', 'KMRY', 'KSNS', 'KSMF', 'KSAC', 'KBAB', 'KMHR', 'KMOD', 'KSCK');
      airspaces = new Map()
      lastone = null;

      function showAirspace(checked, airport)
      {
          if (!airspaces.has(airport)) {
              airspaces.set(airport, new Cesium.Cesium3DTileset({
                  url: 'airspaces/' + airport + ".json"
              }));
          }
          airspace = airspaces.get(airport);
          lastone = airspace;
          if (checked) {
              if (!viewer.scene.primitives.contains(airspace)) {
                  viewer.scene.primitives.add(airspace).readyPromise.then(function(tileset) {
                      viewer.flyTo(airspace, {
                          offset: new Cesium.HeadingPitchRange(0*d2r, -50*d2r, airspace.extras.height)
                      });
                  });
              }
          } else {
              viewer.scene.primitives.remove(airspace);
              airspaces.delete(airport);
          }
      }
      var table = document.getElementById("checkboxes");
      airports.forEach(
          function(airport)
          {
              table.innerHTML += "<tr><td><input type=\"checkbox\" onchange=\"showAirspace(this.checked,'" + airport + "');\"/></td><td>" + airport + "</td></tr>"
          }
      );
    </script>
  </body>
</html>
